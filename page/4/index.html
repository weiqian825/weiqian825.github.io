<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="There is no magic">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="There is no magic">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="There is no magic">

<link rel="canonical" href="http://yoursite.com/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'default'
  };
</script>

  <title>There is no magic</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">There is no magic</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/18/正则表达式RegExp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="weiqian">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="There is no magic">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/18/正则表达式RegExp/" class="post-title-link" itemprop="url">正则表达式RegExp</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-10-18 08:36:12" itemprop="dateCreated datePublished" datetime="2018-10-18T08:36:12+00:00">2018-10-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-09 20:26:28" itemprop="dateModified" datetime="2021-05-09T20:26:28+00:00">2021-05-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="一、概念"><a href="#一、概念" class="headerlink" title="一、概念"></a>一、概念</h3><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp" target="_blank" rel="noopener">RegExp</a><br><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Regular_Expressions" target="_blank" rel="noopener">正则表达式</a></p>
<ol>
<li><p>正则表达式字面量/patterns/flags</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 正则表达式的字面量提供了正则表达式的编译，当正则表达式不变时候，这种方法提供了更好的性能</span></span><br><span class="line"><span class="keyword">const</span> regex = <span class="regexp">/^[a-zA-Z]+[0-9]*\W?_$/gi</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>RegExp对象的构造函数,使用构造函数提供正则表达式的运行时编译 new RegExp(pattern [, flags])</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> regex = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="regexp">/^[a-zA-Z]+[0-9]*\W?_$/</span>, <span class="string">"gi"</span>);</span><br><span class="line"><span class="comment">// 当使用构造函数创造正则对象时，需要常规的字符转义规则（在前面加反斜杠 \）</span></span><br><span class="line"><span class="comment">// new RegExp("pattern") 的时候不要忘记将 \ 进行转义，因为 \ 在字符串里面也是一个转义字符</span></span><br><span class="line"><span class="keyword">let</span> regex = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"^[a-zA-Z]+[0-9]*\\W?_$"</span>, <span class="string">"gi"</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>特殊字符</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/  a. 在非特殊字符之前的反斜杠表示下一个字符是特殊的，不能从字面上解释。 b. 反斜杠也可以将其后的特殊字符，转义为字面量。</span><br><span class="line">^   匹配输入的开始</span><br><span class="line">$   匹配输入的结束</span><br><span class="line">*   匹配前一个表达式<span class="number">0</span>次或多次。等价于 &#123;<span class="number">0</span>,&#125;</span><br><span class="line">+   匹配前面一个表达式<span class="number">1</span>次或者多次</span><br><span class="line">?   匹配前面一个表达式<span class="number">0</span>次或者<span class="number">1</span>次。等价于 &#123;<span class="number">0</span>,<span class="number">1</span>&#125;</span><br><span class="line">.   （小数点）匹配除换行符之外的任何单个字符</span><br><span class="line">(x)     匹配 <span class="string">'x'</span> 并且记住匹配项，就像下面的例子展示的那样。括号被称为 捕获括号</span><br><span class="line">(?:x)   匹配 <span class="string">'x'</span> 但是不记住匹配项。这种叫作非捕获括号</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="二、"><a href="#二、" class="headerlink" title="二、"></a>二、</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/14/vscode插件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="weiqian">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="There is no magic">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/14/vscode插件/" class="post-title-link" itemprop="url">vscode插件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-10-14 10:44:43" itemprop="dateCreated datePublished" datetime="2018-10-14T10:44:43+00:00">2018-10-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-09 20:26:28" itemprop="dateModified" datetime="2021-05-09T20:26:28+00:00">2021-05-09</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li><p>StandardJs</p>
</li>
<li><p>Gitlens</p>
</li>
<li><p>Code Runer</p>
</li>
<li><p>Markdown Preview</p>
</li>
<li><p>Go</p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/14/手写一个promise/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="weiqian">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="There is no magic">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/14/手写一个promise/" class="post-title-link" itemprop="url">手写一个promise</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-10-14 10:44:09" itemprop="dateCreated datePublished" datetime="2018-10-14T10:44:09+00:00">2018-10-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-09 20:26:28" itemprop="dateModified" datetime="2021-05-09T20:26:28+00:00">2021-05-09</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="一、概念"><a href="#一、概念" class="headerlink" title="一、概念"></a>一、概念</h3><p>  promise在javascript早有实现，es6将其写进了语言标准<a href="https://promisesaplus.com/" target="_blank" rel="noopener">PromiseA+</a>，统一了用法，并原生提供了promise对象。<br>  promise就是一个对象，用来传递一步操作的消息。它代表了某个未来才知道结果的事件(通常是一个异步操作)，并且这个实践提供了统一的api，可供进一步处理。<br>  promise对象特点</p>
<ol>
<li>对象状态不受外界影响。Pending|Resolved|Rejected。只有异步操作结果可以决定当前是哪一种状态，其他操作都无法改变这个状态。</li>
<li>一旦状态改变就不会再变。Pending-&gt;Rejected或者Pending-&gt;Rejected，只要其中之一发生，状态就会凝固，不会再变，一直保持这个结果。<br>有了promise，就可以讲异步操作以同步操作的流程表达出来，避免了层层的嵌套的回调函数。<h3 id="二、new-Promise-executor"><a href="#二、new-Promise-executor" class="headerlink" title="二、new Promise(executor)"></a>二、new Promise(executor)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">function MyPromise(executor) &#123;</span><br><span class="line">    let self = this</span><br><span class="line">    self.state = &apos;pending&apos;</span><br><span class="line">    self.value = undefined</span><br><span class="line">    self.reason = undefined</span><br><span class="line">    // resolve的作用是将Promise对象状态从 ‘未完成’ 变成 ‘成功’，在异步操作成功时调用，并将异步操作的结果作为参数传递出去</span><br><span class="line">    function resolve(value)&#123;</span><br><span class="line">        if(self.state === &apos;pending&apos;)&#123;</span><br><span class="line">            self.state = &apos;resolved&apos;</span><br><span class="line">            self.value = value</span><br><span class="line">            console.log(&apos;resolved func --&gt;&apos;,value)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // reject函数的作用是，将promise对象从‘未完成’变成‘失败’，在异步操作失败时候调用，并将异步操作爆出的错误作为参数传递出去</span><br><span class="line">    function reject(reason)&#123;</span><br><span class="line">        if(self.state === &apos;pending&apos;)&#123;</span><br><span class="line">            self.state = &apos;rejected&apos;</span><br><span class="line">            self.reason = reason</span><br><span class="line">            console.log(&apos;reject reason --&gt;&apos;,reason)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    executor(resolve,reject)</span><br><span class="line">&#125;</span><br><span class="line">//promise实栗生成时候，可以用then方法分别指定Resolved和Rejected状态的回调函数。</span><br><span class="line">MyPromise.prototype.then = function (onFulfilled, onRejected)&#123;</span><br><span class="line">    let self = this</span><br><span class="line">    if(self.state === &apos;resolved&apos;)&#123;</span><br><span class="line">        onFulfilled(self.value)</span><br><span class="line">    &#125;</span><br><span class="line">    if(self.state === &apos;rejected&apos;)&#123;</span><br><span class="line">        onRejected(self.reason)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var promise = new MyPromise(function(resolve,reject)&#123;</span><br><span class="line">    resolve(&apos;resolve hahah&apos;)</span><br><span class="line">&#125;)</span><br><span class="line">promise.then(function(value)&#123;</span><br><span class="line">  console.log(&apos;success then --&gt;&apos;,value)</span><br><span class="line">&#125;,function(reason)&#123;</span><br><span class="line">  console.log(&apos;failure then --&gt;&apos;,reason)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="三、基础版本"><a href="#三、基础版本" class="headerlink" title="三、基础版本"></a>三、基础版本</h3><p>// 表示某一段时间以后才会发生的结果，过指定时间后，Promsise的实栗状态会变成resolved<br>function timeout(ms){<br>    return new MyPromise((resolve, reject) =&gt; {<br>        console.log(Date.now())<br>        setTimeout(resolve,ms,’resolve value’)<br>    })<br>}<br>console.log(Date.now())<br>timeout(3000).then((value) =&gt; {<br>    console.log(value)<br>})<br>// 运行刚才的函数，执行了resolved func，却没有执行到then，原因是什么呢？<br>准确的说，应该是由于setTimeout先执行了then,此时的状态却是pending,相当于什么也不做。等状态在3秒后变成了resolved,onFulfilled因为已经执行过了，所以不在执行了。我们对函数进行如下改造。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">function MyPromise(executor) &#123;</span><br><span class="line">    let self = this</span><br><span class="line">    self.state = &apos;pending&apos;</span><br><span class="line">    self.value = undefined</span><br><span class="line">    self.reason = undefined</span><br><span class="line">    self.onResolvedCallbacks = []</span><br><span class="line">    self.onRejectedCallbacks = []</span><br><span class="line">    // resolve的作用是将Promise对象状态从 ‘未完成’ 变成 ‘成功’，在异步操作成功时调用，并将异步操作的结果作为参数传递出去</span><br><span class="line">    function resolve(value)&#123;</span><br><span class="line">        if(self.state === &apos;pending&apos;)&#123;</span><br><span class="line">            self.state = &apos;resolved&apos;</span><br><span class="line">            self.value = value</span><br><span class="line">            console.log(&apos;resolved func --&gt;&apos;,value)</span><br><span class="line">            self.onResolvedCallbacks.forEach(function(fn)&#123;</span><br><span class="line">                fn()</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // reject函数的作用是，将promise对象从‘未完成’变成‘失败’，在异步操作失败时候调用，并将异步操作爆出的错误作为参数传递出去</span><br><span class="line">    function reject(reason)&#123;</span><br><span class="line">        if(self.state === &apos;pending&apos;)&#123;</span><br><span class="line">            self.state = &apos;rejected&apos;</span><br><span class="line">            self.reason = reason</span><br><span class="line">            console.log(&apos;reject reason --&gt;&apos;,reason)</span><br><span class="line">            self.onRejectedCallbacks.forEach(function(fn)&#123;</span><br><span class="line">                fn()</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    executor(resolve,reject)</span><br><span class="line">&#125;</span><br><span class="line">//promise实栗生成时候，可以用then方法分别指定Resolved和Rejected状态的回调函数。</span><br><span class="line">MyPromise.prototype.then = function (onFulfilled, onRejected)&#123;</span><br><span class="line">    let self = this</span><br><span class="line">    if(self.state === &apos;resolved&apos;)&#123;</span><br><span class="line">        onFulfilled(self.value)</span><br><span class="line">    &#125;</span><br><span class="line">    if(self.state === &apos;rejected&apos;)&#123;</span><br><span class="line">        onRejected(self.reason)</span><br><span class="line">    &#125;</span><br><span class="line">    if(self.state === &apos;pending&apos;)&#123;</span><br><span class="line">        self.onResolvedCallbacks.push(function()&#123;</span><br><span class="line">            onFulfilled(self.value)</span><br><span class="line">        &#125;)</span><br><span class="line">        self.onRejectedCallbacks.push(function()&#123;</span><br><span class="line">            onRejected(self.reason)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// 表示某一段时间以后才会发生的结果，过指定时间后，Promsise的实栗状态会变成resolved</span><br><span class="line">function timeout(ms)&#123;</span><br><span class="line">    return new MyPromise((resolve, reject) =&gt; &#123;</span><br><span class="line">        setTimeout(resolve,ms,&apos;resolve value&apos;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">console.log(Date.now())</span><br><span class="line">timeout(3000).then((value) =&gt; &#123;</span><br><span class="line">    console.log(value)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="四、promise-then"><a href="#四、promise-then" class="headerlink" title="四、promise then"></a>四、promise then</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/13/jenkins本地集成/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="weiqian">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="There is no magic">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/13/jenkins本地集成/" class="post-title-link" itemprop="url">jenkins本地集成</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-10-13 11:14:54" itemprop="dateCreated datePublished" datetime="2018-10-13T11:14:54+00:00">2018-10-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-09 20:26:28" itemprop="dateModified" datetime="2021-05-09T20:26:28+00:00">2021-05-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tools/" itemprop="url" rel="index"><span itemprop="name">tools</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>工作中，总能遇到一些奇葩的事情，例如jenkins在build的时候有时候会失败，qa在群里@开发，开发build下，又成功了，也是一脸蒙蔽。</p>
<h3 id="一、本地安装jenkins"><a href="#一、本地安装jenkins" class="headerlink" title="一、本地安装jenkins"></a>一、本地安装jenkins</h3><ol>
<li><p>java安装，没有安装先去安装<a href="https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="noopener">java环境</a>，安装的跳过。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -version</span><br></pre></td></tr></table></figure>
</li>
<li><p>brew安装，没安装的执行命令，安装的跳过。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装jenkins</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install jenkins</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动jenkins</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jenkins</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问jenkins</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8080/</span><br></pre></td></tr></table></figure>
</li>
<li><p>账号设置、安装推荐插件、创建管理员用户，总之跟着提示做就好了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /Users/weiqian/.jenkins/secrets/initialAdminPassword</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="二、实战操作"><a href="#二、实战操作" class="headerlink" title="二、实战操作"></a>二、实战操作</h3><ol>
<li><p>安装插件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">系统管理 - &gt; 插件管理 - &gt;available - &gt; 过滤 - &gt;选择插件 -&gt; 直接安装</span><br><span class="line">Xcode integration （必须）</span><br><span class="line">Keychains and Provisioning Profiles Management （必须）</span><br><span class="line">Email Extension Template</span><br><span class="line">CocoaPods Jenkins Integration</span><br><span class="line">GitLab</span><br><span class="line">GitLab Hook</span><br><span class="line">GitLab Authentication</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置Keychains and Provisioning Profiles Management </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// step1. 系统管理 -&gt; Keychains and Provisioning Profiles Management </span><br><span class="line">cp /Users/weiqian/Library/Keychains/login.keychain-db /Users/weiqian/Desktop/login.keychain</span><br><span class="line">// step2. upload desktop login.keychain</span><br><span class="line">// step3. Provisioning Profiles Directory Path fill path</span><br><span class="line">/Users/weiqian/Library/MobileDevice/Provisioning Profiles</span><br><span class="line">// step4. save</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new Task -&gt; 自由风格的软件项目 -&gt; General -&gt; 源码管理 -&gt; 构建触发器</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>表面上看起来是成功了。<br>路漫漫，未完待续····</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/11/hexo-配置优化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="weiqian">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="There is no magic">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/11/hexo-配置优化/" class="post-title-link" itemprop="url">hexo 添加categories|tags|文章预览|搜索等</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-10-11 16:19:26" itemprop="dateCreated datePublished" datetime="2018-10-11T16:19:26+00:00">2018-10-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-09 20:26:28" itemprop="dateModified" datetime="2021-05-09T20:26:28+00:00">2021-05-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tools/" itemprop="url" rel="index"><span itemprop="name">tools</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="一、添加categories"><a href="#一、添加categories" class="headerlink" title="一、添加categories"></a>一、添加categories</h3><ol>
<li><p>执行命令 hexo new page categories</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  hexo git:(master) hexo new page categories</span><br><span class="line">INFO  Created: ~/Desktop/xxxxx/hexo/<span class="built_in">source</span>/categories/index.md</span><br><span class="line">➜  hexo git:(master) ✗ cat <span class="built_in">source</span>/categories/index.md</span><br><span class="line">---</span><br><span class="line">title: categories</span><br><span class="line">date: 2018-10-11 15:38:12</span><br><span class="line"><span class="built_in">type</span>: <span class="string">"categories"</span></span><br><span class="line">---</span><br></pre></td></tr></table></figure>
</li>
<li><p>具体文章添加categories</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">title: hexo 添加categories和tags</span><br><span class="line">date: 2018-10-11 16:19:26</span><br><span class="line">categories: </span><br><span class="line">- tools</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改themes/next/_config.yml里面的配置，去掉categories的屏蔽</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">menu:</span><br><span class="line">  home: / || home</span><br><span class="line">  #about: /about/ || user</span><br><span class="line">  #tags: /tags/ || tags</span><br><span class="line">  categories: /categories/ || th</span><br><span class="line">  archives: /archives/ || archive</span><br><span class="line">  #schedule: /schedule/ || calendar</span><br><span class="line">  #sitemap: /sitemap.xml || sitemap</span><br><span class="line">  #commonweal: /404/ || heartbeat</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="二、添加tags"><a href="#二、添加tags" class="headerlink" title="二、添加tags"></a>二、添加tags</h3><ol>
<li><p>执行命令 hexo new page tags</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  hexo git:(master) ✗ hexo new page tags</span><br><span class="line">INFO  Created: ~/Desktop/xxxxx/hexo/source/tags/index.md</span><br><span class="line">➜  hexo git:(master) ✗ cat  source/tags/index.md</span><br><span class="line">---</span><br><span class="line">title: tags</span><br><span class="line">date: 2018-10-11 16:01:45</span><br><span class="line">type: &quot;tags&quot;</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
</li>
<li><p>具体文章添加tags</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">title: hexo 添加categories和tags</span><br><span class="line">date: 2018-10-11 16:19:26</span><br><span class="line">categories: </span><br><span class="line">- tools</span><br><span class="line">tags:</span><br><span class="line">- hexo</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改themes/next/_config.yml里面的配置，去掉categories的屏蔽</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">menu:</span><br><span class="line">  home: / || home</span><br><span class="line">  #about: /about/ || user</span><br><span class="line">  tags: /tags/ || tags</span><br><span class="line">  categories: /categories/ || th</span><br><span class="line">  archives: /archives/ || archive</span><br><span class="line">  #schedule: /schedule/ || calendar</span><br><span class="line">  #sitemap: /sitemap.xml || sitemap</span><br><span class="line">  #commonweal: /404/ || heartbeat</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="三、文章预览"><a href="#三、文章预览" class="headerlink" title="三、文章预览"></a>三、文章预览</h3><ol>
<li>修改themes/next/_config.yml文件里面auto_excerpt的enable属性改为true<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">auto_excerpt:</span><br><span class="line">  enable: true</span><br><span class="line">  length: 150</span><br></pre></td></tr></table></figure>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/11/nginx和lua的简单使用-OpenResty/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="weiqian">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="There is no magic">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/11/nginx和lua的简单使用-OpenResty/" class="post-title-link" itemprop="url">nginx和lua的简单使用-openresty</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-10-11 00:09:58" itemprop="dateCreated datePublished" datetime="2018-10-11T00:09:58+00:00">2018-10-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-09 20:26:28" itemprop="dateModified" datetime="2021-05-09T20:26:28+00:00">2021-05-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nginx/" itemprop="url" rel="index"><span itemprop="name">nginx</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="https://openresty.org/cn/" target="_blank" rel="noopener">OpenResty</a> 是一款基于 NGINX 和 LuaJIT 的 Web 平台</p>
<h3 id="一、安装环境"><a href="#一、安装环境" class="headerlink" title="一、安装环境"></a>一、安装环境</h3><ol>
<li>根据官网教程，macos我们只需要一行命令就可以开心的安装openresty (brew install openresty/brew/openresty)</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line">➜  sshkey brew untap homebrew/nginx</span><br><span class="line">Error: No available tap homebrew/nginx.</span><br><span class="line">➜  sshkey brew install openresty/brew/openresty</span><br><span class="line">Updating Homebrew...</span><br><span class="line">==&gt; Tapping openresty/brew</span><br><span class="line">Cloning into <span class="string">'/usr/local/Homebrew/Library/Taps/openresty/homebrew-brew'</span>...</span><br><span class="line">remote: Enumerating objects: 72, <span class="keyword">done</span>.</span><br><span class="line">remote: Counting objects: 100% (72/72), <span class="keyword">done</span>.</span><br><span class="line">remote: Compressing objects: 100% (71/71), <span class="keyword">done</span>.</span><br><span class="line">remote: Total 72 (delta 1), reused 32 (delta 1), pack-reused 0</span><br><span class="line">Unpacking objects: 100% (72/72), <span class="keyword">done</span>.</span><br><span class="line">Tapped 62 formulae (162 files, 132.9KB).</span><br><span class="line">==&gt; Installing openresty from openresty/brew</span><br><span class="line">==&gt; Installing dependencies <span class="keyword">for</span> openresty/brew/openresty: openresty/brew/openresty-openssl and geoip</span><br><span class="line">==&gt; Installing openresty/brew/openresty dependency: openresty/brew/openresty-openssl</span><br><span class="line">==&gt; Downloading https://www.openssl.org/<span class="built_in">source</span>/openssl-1.1.0h.tar.gz</span><br><span class="line"><span class="comment">######################################################################## 100.0%</span></span><br><span class="line">==&gt; Downloading https://raw.githubusercontent.com/openresty/openresty/master/patches/openssl-1.1.0d<span class="_">-s</span></span><br><span class="line"><span class="comment">######################################################################## 100.0%</span></span><br><span class="line">==&gt; Patching</span><br><span class="line">==&gt; Applying openssl-1.1.0d-sess_set_get_cb_yield.patch</span><br><span class="line">patching file include/openssl/bio.h</span><br><span class="line">Hunk <span class="comment">#1 succeeded at 217 (offset -3 lines).</span></span><br><span class="line">patching file include/openssl/ssl.h</span><br><span class="line">Hunk <span class="comment">#1 succeeded at 812 (offset 21 lines).</span></span><br><span class="line">Hunk <span class="comment">#2 succeeded at 821 (offset 21 lines).</span></span><br><span class="line">Hunk <span class="comment">#3 succeeded at 1054 (offset 21 lines).</span></span><br><span class="line">Hunk <span class="comment">#4 succeeded at 1461 with fuzz 1 (offset 31 lines).</span></span><br><span class="line">patching file ssl/bio_ssl.c</span><br><span class="line">Hunk <span class="comment">#1 succeeded at 139 (offset 1 line).</span></span><br><span class="line">Hunk <span class="comment">#2 succeeded at 215 (offset 1 line).</span></span><br><span class="line">Hunk <span class="comment">#3 succeeded at 372 (offset 1 line).</span></span><br><span class="line">patching file ssl/ssl_lib.c</span><br><span class="line">Hunk <span class="comment">#1 succeeded at 3177 (offset 195 lines).</span></span><br><span class="line">patching file ssl/ssl_sess.c</span><br><span class="line">Hunk <span class="comment">#2 succeeded at 512 (offset 8 lines).</span></span><br><span class="line">Hunk <span class="comment">#3 succeeded at 901 (offset 9 lines).</span></span><br><span class="line">patching file ssl/statem/statem.c</span><br><span class="line">Hunk <span class="comment">#1 succeeded at 591 (offset 8 lines).</span></span><br><span class="line">Hunk <span class="comment">#2 succeeded at 622 (offset 8 lines).</span></span><br><span class="line">patching file ssl/statem/statem.h</span><br><span class="line">patching file ssl/statem/statem_srvr.c</span><br><span class="line">Hunk <span class="comment">#1 succeeded at 1147 (offset -18 lines).</span></span><br><span class="line">patching file util/libssl.num</span><br><span class="line">==&gt; perl ./Configure --prefix=/usr/<span class="built_in">local</span>/Cellar/openresty-openssl/1.1.0h_1 --openssldir=/usr/<span class="built_in">local</span>/et</span><br><span class="line">==&gt; make</span><br><span class="line">==&gt; make install MANDIR=/usr/<span class="built_in">local</span>/Cellar/openresty-openssl/1.1.0h_1/share/man MANSUFFIX=ssl</span><br><span class="line">==&gt; Caveats</span><br><span class="line">openresty-openssl is keg-only, <span class="built_in">which</span> means it was not symlinked into /usr/<span class="built_in">local</span>,</span><br><span class="line">because only <span class="keyword">for</span> use with OpenResty.</span><br><span class="line"></span><br><span class="line">If you need to have openresty-openssl first <span class="keyword">in</span> your PATH run:</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">'export PATH="/usr/local/opt/openresty-openssl/bin:$PATH"'</span> &gt;&gt; ~/.zshrc</span><br><span class="line"></span><br><span class="line">For compilers to find openresty-openssl you may need to <span class="built_in">set</span>:</span><br><span class="line">  <span class="built_in">export</span> LDFLAGS=<span class="string">"-L/usr/local/opt/openresty-openssl/lib"</span></span><br><span class="line">  <span class="built_in">export</span> CPPFLAGS=<span class="string">"-I/usr/local/opt/openresty-openssl/include"</span></span><br><span class="line"></span><br><span class="line">For pkg-config to find openresty-openssl you may need to <span class="built_in">set</span>:</span><br><span class="line">  <span class="built_in">export</span> PKG_CONFIG_PATH=<span class="string">"/usr/local/opt/openresty-openssl/lib/pkgconfig"</span></span><br><span class="line"></span><br><span class="line">==&gt; Summary</span><br><span class="line">🍺  /usr/<span class="built_in">local</span>/Cellar/openresty-openssl/1.1.0h_1: 6,583 files, 15.6MB, built <span class="keyword">in</span> 5 minutes 43 seconds</span><br><span class="line">==&gt; Installing openresty/brew/openresty dependency: geoip</span><br><span class="line">==&gt; Downloading https://homebrew.bintray.com/bottles/geoip-1.6.12.high_sierra.bottle.tar.gz</span><br><span class="line"><span class="comment">######################################################################## 100.0%</span></span><br><span class="line">==&gt; Pouring geoip-1.6.12.high_sierra.bottle.tar.gz</span><br><span class="line">🍺  /usr/<span class="built_in">local</span>/Cellar/geoip/1.6.12: 18 files, 548.9KB</span><br><span class="line">==&gt; Installing openresty/brew/openresty</span><br><span class="line">==&gt; Downloading https://openresty.org/download/openresty-1.13.6.2.tar.gz</span><br><span class="line"><span class="comment">######################################################################## 100.0%</span></span><br><span class="line">==&gt; ./configure --prefix=/usr/<span class="built_in">local</span>/Cellar/openresty/1.13.6.2 --pid-path=/usr/<span class="built_in">local</span>/var/run/openresty</span><br><span class="line">==&gt; make</span><br><span class="line">==&gt; make install</span><br><span class="line">==&gt; Caveats</span><br><span class="line">To have launchd start openresty/brew/openresty now and restart at login:</span><br><span class="line">  brew services start openresty/brew/openresty</span><br><span class="line">Or, <span class="keyword">if</span> you don<span class="string">'t want/need a background service you can just run:</span></span><br><span class="line"><span class="string">  openresty</span></span><br><span class="line"><span class="string">==&gt; Summary</span></span><br><span class="line"><span class="string">🍺  /usr/local/Cellar/openresty/1.13.6.2: 293 files, 6.3MB, built in 1 minute 26 seconds</span></span><br><span class="line"><span class="string">==&gt; Caveats</span></span><br><span class="line"><span class="string">==&gt; openresty-openssl</span></span><br><span class="line"><span class="string">openresty-openssl is keg-only, which means it was not symlinked into /usr/local,</span></span><br><span class="line"><span class="string">because only for use with OpenResty.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">If you need to have openresty-openssl first in your PATH run:</span></span><br><span class="line"><span class="string">  echo '</span><span class="built_in">export</span> PATH=<span class="string">"/usr/local/opt/openresty-openssl/bin:<span class="variable">$PATH</span>"</span><span class="string">' &gt;&gt; ~/.zshrc</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">For compilers to find openresty-openssl you may need to set:</span></span><br><span class="line"><span class="string">  export LDFLAGS="-L/usr/local/opt/openresty-openssl/lib"</span></span><br><span class="line"><span class="string">  export CPPFLAGS="-I/usr/local/opt/openresty-openssl/include"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">For pkg-config to find openresty-openssl you may need to set:</span></span><br><span class="line"><span class="string">  export PKG_CONFIG_PATH="/usr/local/opt/openresty-openssl/lib/pkgconfig"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">==&gt; openresty</span></span><br><span class="line"><span class="string">To have launchd start openresty/brew/openresty now and restart at login:</span></span><br><span class="line"><span class="string">  brew services start openresty/brew/openresty</span></span><br><span class="line"><span class="string">Or, if you don'</span>t want/need a background service you can just run:</span><br><span class="line">  openresty</span><br><span class="line">➜  sshkey brew services start openresty/brew/openresty</span><br><span class="line">==&gt; Tapping homebrew/services</span><br><span class="line">Cloning into <span class="string">'/usr/local/Homebrew/Library/Taps/homebrew/homebrew-services'</span>...</span><br><span class="line">remote: Enumerating objects: 14, <span class="keyword">done</span>.</span><br><span class="line">remote: Counting objects: 100% (14/14), <span class="keyword">done</span>.</span><br><span class="line">remote: Compressing objects: 100% (10/10), <span class="keyword">done</span>.</span><br><span class="line">remote: Total 14 (delta 0), reused 9 (delta 0), pack-reused 0</span><br><span class="line">Unpacking objects: 100% (14/14), <span class="keyword">done</span>.</span><br><span class="line">Tapped 1 <span class="built_in">command</span> (43 files, 55.6KB).</span><br><span class="line">==&gt; Successfully started `openresty` (label: homebrew.mxcl.openresty)</span><br><span class="line">➜  sshkey sudo find / -name nginx</span><br><span class="line">Password:</span><br><span class="line">/usr/<span class="built_in">local</span>/bin/nginx</span><br><span class="line">/usr/<span class="built_in">local</span>/etc/nginx</span><br><span class="line">/usr/<span class="built_in">local</span>/var/homebrew/linked/nginx</span><br><span class="line">/usr/<span class="built_in">local</span>/var/<span class="built_in">log</span>/nginx</span><br><span class="line">/usr/<span class="built_in">local</span>/var/run/nginx</span><br><span class="line">/usr/<span class="built_in">local</span>/opt/nginx</span><br><span class="line">/usr/<span class="built_in">local</span>/Cellar/openresty/1.13.6.2/pod/nginx</span><br><span class="line">/usr/<span class="built_in">local</span>/Cellar/openresty/1.13.6.2/nginx</span><br><span class="line">/usr/<span class="built_in">local</span>/Cellar/openresty/1.13.6.2/nginx/sbin/nginx=====&gt; this is you need add nginx path</span><br><span class="line">/usr/<span class="built_in">local</span>/Cellar/nginx</span><br><span class="line">/usr/<span class="built_in">local</span>/Cellar/nginx/1.15.5/bin/nginx</span><br><span class="line">/usr/<span class="built_in">local</span>/Cellar/nginx/1.15.5/.bottle/etc/nginx</span><br><span class="line">/usr/<span class="built_in">local</span>/Cellar/nginx/1.15.5/.bottle/var/<span class="built_in">log</span>/nginx</span><br><span class="line">^C</span><br><span class="line">sudo vim ~/.bash_profile</span><br><span class="line">➜  sshkey nginx -v</span><br><span class="line">nginx version: nginx/1.15.5</span><br><span class="line">➜  sshkey brew uninstall nginx</span><br><span class="line">Uninstalling /usr/<span class="built_in">local</span>/Cellar/nginx/1.15.5... (23 files, 1.4MB)</span><br><span class="line">➜  sshkey nginx</span><br><span class="line">zsh: <span class="built_in">command</span> not found: nginx</span><br><span class="line">➜  sshkey <span class="built_in">source</span> ~/.bash_profile</span><br><span class="line">➜  sshkey nginx -v</span><br><span class="line">nginx version: openresty/1.13.6.2</span><br><span class="line">➜  sshkey <span class="built_in">history</span> | grep  nginx-https.conf</span><br><span class="line"> 2821* touch nginx-https.conf</span><br><span class="line"> 2822* vim nginx-https.conf</span><br><span class="line"> 2825* sudo  nginx -c  /Users/weiqian/sshkey/nginx-https.conf</span><br><span class="line"> 2831* sudo  nginx -c  /Users/weiqian/sshkey/nginx-https.conf</span><br><span class="line"> 2833* sudo  nginx -c  /Users/weiqian/sshkey/nginx-https.conf</span><br><span class="line"> 2834* vim nginx-https.conf</span><br><span class="line"> 2836* sudo  nginx -c  /Users/weiqian/sshkey/nginx-https.conf</span><br><span class="line"> 2847* open nginx-https.conf</span><br><span class="line">➜  sshkey <span class="built_in">history</span> | grep stop</span><br><span class="line"> 2594  nginx -s stop -c /usr/<span class="built_in">local</span>/etc/nginx/nginx.conf</span><br><span class="line"> 2719* nginx -s stop</span><br><span class="line"> 2824* sudo nginx -s stop</span><br><span class="line"> 2832* sudo nginx -s stop</span><br><span class="line"> 2835* sudo nginx -s stop</span><br><span class="line">➜  sshkey sudo nginx -s stop</span><br><span class="line">nginx: [error] invalid PID number <span class="string">""</span> <span class="keyword">in</span> <span class="string">"/usr/local/var/run/openresty.pid"</span></span><br><span class="line">➜  sshkey sudo  nginx -t -c  /Users/weiqian/sshkey/nginx-https.conf</span><br><span class="line">nginx: the configuration file /Users/weiqian/sshkey/nginx-https.conf syntax is ok</span><br><span class="line">nginx: configuration file /Users/weiqian/sshkey/nginx-https.conf <span class="built_in">test</span> is successful</span><br><span class="line">➜  sshkey sudo  nginx  -c  /Users/weiqian/sshkey/nginx-https.conf</span><br><span class="line">Password:</span><br><span class="line">nginx: [emerg] <span class="built_in">bind</span>() to 0.0.0.0:80 failed (48: Address already <span class="keyword">in</span> use)</span><br><span class="line">nginx: [emerg] <span class="built_in">bind</span>() to 0.0.0.0:443 failed (48: Address already <span class="keyword">in</span> use)</span><br><span class="line">nginx: [emerg] <span class="built_in">bind</span>() to 0.0.0.0:80 failed (48: Address already <span class="keyword">in</span> use)</span><br><span class="line">nginx: [emerg] <span class="built_in">bind</span>() to 0.0.0.0:443 failed (48: Address already <span class="keyword">in</span> use)</span><br><span class="line">nginx: [emerg] <span class="built_in">bind</span>() to 0.0.0.0:80 failed (48: Address already <span class="keyword">in</span> use)</span><br><span class="line">nginx: [emerg] <span class="built_in">bind</span>() to 0.0.0.0:443 failed (48: Address already <span class="keyword">in</span> use)</span><br><span class="line">nginx: [emerg] <span class="built_in">bind</span>() to 0.0.0.0:80 failed (48: Address already <span class="keyword">in</span> use)</span><br><span class="line">nginx: [emerg] <span class="built_in">bind</span>() to 0.0.0.0:443 failed (48: Address already <span class="keyword">in</span> use)</span><br><span class="line">nginx: [emerg] <span class="built_in">bind</span>() to 0.0.0.0:80 failed (48: Address already <span class="keyword">in</span> use)</span><br><span class="line">nginx: [emerg] <span class="built_in">bind</span>() to 0.0.0.0:443 failed (48: Address already <span class="keyword">in</span> use)</span><br><span class="line">nginx: [emerg] still could not <span class="built_in">bind</span>()</span><br><span class="line">➜  sshkey sudo lsof -i 4tcp:8080</span><br><span class="line">➜  sshkey sudo ps aux | grep nginx</span><br><span class="line">weiqian          12641   1.8  0.0  4286184    920 s004  S+   12:59上午   0:00.01 grep --color=auto --exclude-dir=.bzr --exclude-dir=CVS --exclude-dir=.git --exclude-dir=.hg --exclude-dir=.svn nginx</span><br><span class="line">root             90055   0.0  0.0  4299904   1404   ??  S    11:49下午   0:00.02 nginx: worker process</span><br><span class="line">root             90054   0.0  0.0  4291212    200   ??  Ss   11:49下午   0:00.00 nginx: master process nginx -c /Users/weiqian/sshkey/nginx-https.conf</span><br><span class="line">➜  sshkey sudo <span class="built_in">kill</span> -9 90054</span><br><span class="line">➜  sshkey sudo <span class="built_in">kill</span> -9 90055</span><br><span class="line">➜  sshkey sudo ps aux | grep nginx</span><br><span class="line">weiqian          12677   0.0  0.0  4276968    900 s004  S+   12:59上午   0:00.00 grep --color=auto --exclude-dir=.bzr --exclude-dir=CVS --exclude-dir=.git --exclude-dir=.hg --exclude-dir=.svn nginx</span><br><span class="line">➜  sshkey sudo nginx -s stop</span><br><span class="line">nginx: [error] invalid PID number <span class="string">""</span> <span class="keyword">in</span> <span class="string">"/usr/local/var/run/openresty.pid"</span></span><br><span class="line">➜  sshkey sudo  nginx  -c  /Users/weiqian/sshkey/nginx-https.conf</span><br></pre></td></tr></table></figure>
<p>测试的nginx文件配置<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span> root owner;</span><br><span class="line"><span class="attribute">worker_processes</span> <span class="number">1</span>;</span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line"> <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line">http&#123;</span><br><span class="line">  server&#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> www.example.com;</span><br><span class="line">    <span class="attribute">root</span> /Users/weiqian/sshkey;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">      <span class="attribute">return</span>   <span class="number">301</span>  https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> /test-lua &#123;</span><br><span class="line">      <span class="attribute">default_type</span> text/html;</span><br><span class="line">      <span class="attribute">content_by_lua</span> <span class="string">'</span></span><br><span class="line"><span class="string">        ngx.say("&lt;p&gt;hello, world&lt;/p&gt;")</span></span><br><span class="line"><span class="string">      '</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="section">server</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">server_name</span> www.example.com;</span><br><span class="line">    <span class="attribute">root</span> /Users/weiqian/sshkey;</span><br><span class="line">    <span class="attribute">ssl_certificate</span>       /Users/weiqian/sshkey/demoCA/www.example.com.crt; </span><br><span class="line">    <span class="attribute">ssl_certificate_key</span>   /Users/weiqian/sshkey/demoCA/www.example.com.key; </span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">      <span class="attribute">index</span> index.html;</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="attribute">location</span> /produk-digital/m &#123;</span><br><span class="line">        <span class="attribute">try_files</span>     <span class="variable">$uri</span>      /digital-product/m/index.html;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> = /digital-product/m/index.html &#123;</span><br><span class="line">        <span class="attribute">alias</span>       /Users/weiqian/sshkey/index.html;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>访问<a href="http://www.example.com/test-lua页面显示hello" target="_blank" rel="noopener">http://www.example.com/test-lua页面显示hello</a> world说明我们lua环境配置正确可以，开始编写lua脚本了</p>
<h3 id="二、lua脚本配置关闭http链接，所有链接跳转到https"><a href="#二、lua脚本配置关闭http链接，所有链接跳转到https" class="headerlink" title="二、lua脚本配置关闭http链接，所有链接跳转到https"></a>二、lua脚本配置关闭http链接，所有链接跳转到https</h3><ol>
<li><p>lua的nginx模块具体代码如下</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">access_by_lua_block</span> &#123;</span><br><span class="line">    <span class="attribute">if</span> ngx.var.scheme == <span class="string">'http'</span> then</span><br><span class="line">        return ngx.<span class="literal">redirect</span>(<span class="string">"https://"</span> .. ngx.var.host .. ngx.var.request_uri)</span><br><span class="line">    end</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改后的本地测试实栗</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span> root owner;</span><br><span class="line"></span><br><span class="line"><span class="attribute">worker_processes</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line"> <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http&#123;</span><br><span class="line"> <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">443</span> ssl http2; </span><br><span class="line">    <span class="attribute">server_name</span> www.example.com;</span><br><span class="line">    <span class="attribute">ssl_certificate</span>       /Users/weiqian/sshkey/demoCA/www.example.com.crt; </span><br><span class="line">    <span class="attribute">ssl_certificate_key</span>   /Users/weiqian/sshkey/demoCA/www.example.com.key; </span><br><span class="line"></span><br><span class="line">    <span class="comment">## begin of digital purchase ##</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">try_files</span>     <span class="variable">$uri</span>      /digital-product/m/index.html;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> /produk-digital/m &#123;</span><br><span class="line">        <span class="attribute">try_files</span>     <span class="variable">$uri</span>      /digital-product/m/index.html;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> /digital-product/m &#123;</span><br><span class="line">        <span class="attribute">try_files</span>     <span class="variable">$uri</span>      /digital-product/m/index.html;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">access_by_lua_block</span> &#123;</span><br><span class="line">        <span class="attribute">if</span> ngx.var.scheme == <span class="string">'http'</span> then</span><br><span class="line">            return ngx.<span class="literal">redirect</span>(<span class="string">"https://"</span> .. ngx.var.host .. ngx.var.request_uri)</span><br><span class="line">        end</span><br><span class="line">    &#125;</span><br><span class="line">    location = /digital-product/m/index.html &#123;</span><br><span class="line">        <span class="attribute">alias</span>                   /Users/weiqian/sshkey/index.html;</span><br><span class="line">        <span class="attribute">access_log</span>              <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">add_header</span>              Cache-Control <span class="string">"no-cache, no-store"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> /digital-product/static/ &#123;</span><br><span class="line">        <span class="attribute">alias</span>                   /Users/weiqian/sshkey/;</span><br><span class="line">        <span class="attribute">access_log</span>              <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">expires</span>                 <span class="number">30d</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">## end of digital purchase #</span></span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>存在问题，我们刚才的配置将所有的域名都转到了https实际上我们只想改自己配置，不要影响别人的业务<br>向location = /digital-product/m/index.html添加链接即可</p>
</li>
</ol>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span> root owner;</span><br><span class="line"></span><br><span class="line"><span class="attribute">worker_processes</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line"> <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http&#123;</span><br><span class="line"> <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">443</span> ssl http2; </span><br><span class="line">    <span class="attribute">server_name</span> www.example.com;</span><br><span class="line">    <span class="attribute">ssl_certificate</span>       /Users/weiqian/sshkey/demoCA/www.example.com.crt; </span><br><span class="line">    <span class="attribute">ssl_certificate_key</span>   /Users/weiqian/sshkey/demoCA/www.example.com.key; </span><br><span class="line"></span><br><span class="line">    <span class="comment">## begin of digital purchase ##</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> /produk-digital/m &#123;</span><br><span class="line">        <span class="attribute">try_files</span>     <span class="variable">$uri</span>      /digital-product/m/index.html;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> /digital-product/m &#123;</span><br><span class="line">        <span class="attribute">try_files</span>     <span class="variable">$uri</span>      /digital-product/m/index.html;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="attribute">location</span> = /digital-product/m/index.html &#123;</span><br><span class="line">        <span class="section">access_by_lua_block</span> &#123;</span><br><span class="line">          <span class="attribute">if</span> ngx.var.scheme == <span class="string">'http'</span> then</span><br><span class="line">            return ngx.<span class="literal">redirect</span>(<span class="string">"https://"</span> .. ngx.var.host .. ngx.var.request_uri)</span><br><span class="line">          end</span><br><span class="line">        &#125;</span><br><span class="line">        alias                   /Users/weiqian/sshkey/index.html;</span><br><span class="line">        <span class="attribute">access_log</span>              <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">add_header</span>              Cache-Control <span class="string">"no-cache, no-store"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> /digital-product/static/ &#123;</span><br><span class="line">        <span class="attribute">alias</span>                   /Users/weiqian/sshkey/;</span><br><span class="line">        <span class="attribute">access_log</span>              <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">expires</span>                 <span class="number">30d</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> /testlua/ &#123;</span><br><span class="line">       <span class="attribute">alias</span>        /Users/weiqian/sshkey/testlua/;</span><br><span class="line">       <span class="attribute">expires</span>      <span class="number">30d</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">## end of digital purchase #</span></span><br><span class="line"></span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="三、lua脚本配置关闭http链接，所有链接跳转到https"><a href="#三、lua脚本配置关闭http链接，所有链接跳转到https" class="headerlink" title="三、lua脚本配置关闭http链接，所有链接跳转到https"></a>三、lua脚本配置关闭http链接，所有链接跳转到https</h3><p>在test和uat环境部署了配置之后都没有问题，live环境居然不生效， <a href="http://xxxxx.co.id/produk-digital/m/?debug=1" target="_blank" rel="noopener">http://xxxxx.co.id/produk-digital/m/?debug=1</a> 链接并没有跳转到https<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ dig xxxxx.co.id</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; xxxxx.co.id</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 47849</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 9, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;xxxxx.co.id.			IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">xxxxx.co.id.		525	IN	A	119.28.186.208</span><br><span class="line">xxxxx.co.id.		525	IN	A	119.28.133.34</span><br><span class="line">xxxxx.co.id.		525	IN	A	119.28.20.204</span><br><span class="line">xxxxx.co.id.		525	IN	A	119.28.181.96</span><br><span class="line">xxxxx.co.id.		525	IN	A	119.28.45.94</span><br><span class="line">xxxxx.co.id.		525	IN	A	119.28.72.242</span><br><span class="line">xxxxx.co.id.		525	IN	A	119.28.177.221</span><br><span class="line">xxxxx.co.id.		525	IN	A	119.28.142.226</span><br><span class="line">xxxxx.co.id.		525	IN	A	119.28.188.88</span><br><span class="line"></span><br><span class="line">;; Query time: 20 msec</span><br><span class="line">;; SERVER: 10.12.77.201<span class="comment">#53(10.12.77.201)</span></span><br><span class="line">;; WHEN: Sat Oct 13 15:51:58 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 185</span><br></pre></td></tr></table></figure></p>
<p>dig之后发现指向了香港集群，在部署一下香港集群，再访问ng配置生效了。为了加4行代码也是不容易。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/10/本地搭建nginx-https服务/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="weiqian">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="There is no magic">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/10/本地搭建nginx-https服务/" class="post-title-link" itemprop="url">本地搭建nginx https服务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-10-10 16:43:19" itemprop="dateCreated datePublished" datetime="2018-10-10T16:43:19+00:00">2018-10-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-09 20:26:28" itemprop="dateModified" datetime="2021-05-09T20:26:28+00:00">2021-05-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nginx/" itemprop="url" rel="index"><span itemprop="name">nginx</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>  前几天，pm反馈页面被运营商劫持，出现了小广告，我们检查了项目内并没有http链接，理论上都是https应该不回被劫持，后来发现反馈的页面是外部的投放资源是http，另外我们的nginx配置的兜底策略关闭掉直接访问页面的http链接。所以需要在本地验证一波https的nginx配置。</p>
<h3 id="一、相关原理"><a href="#一、相关原理" class="headerlink" title="一、相关原理"></a>一、相关原理</h3><ol>
<li>对称加密</li>
<li>非对称加密</li>
<li>https采用的是对称加密和非对称加密混合的方式</li>
<li>https tls握手过程</li>
<li>https session Key</li>
<li>openssl</li>
</ol>
<h3 id="二、生成本地证书"><a href="#二、生成本地证书" class="headerlink" title="二、生成本地证书"></a>二、生成本地证书</h3><ol>
<li><p>具体命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// a. 准备工作，这里新建目录在～，遇到一个建desktop，后面的nginx404的坑原因不明</span><br><span class="line"><span class="built_in">cd</span> ~ &amp;&amp; mkdir sshkey &amp;&amp; <span class="built_in">cd</span> sshkey &amp;&amp; mkdir demoCA &amp;&amp; <span class="built_in">cd</span> demoCA &amp;&amp; touch index.txt &amp;&amp; touch serial &amp;&amp; <span class="built_in">echo</span> <span class="string">"01"</span>&gt;./serial &amp;&amp; mkdir newcerts</span><br><span class="line">// b. 生成ca.key CA私钥</span><br><span class="line">openssl genrsa -des3 -out ca.key 2048</span><br><span class="line">// c. 生成ca.crt CA根证书（公钥）</span><br><span class="line">openssl req -new -x509 -days 7305 -key ca.key -out ca.crt</span><br><span class="line">// d. 生成www.example.com证书私钥：</span><br><span class="line">openssl genrsa -des3 -out www.example.com.pem 1024</span><br><span class="line">// e. 制作解密后的www.example.com证书私钥，一定要填写common.name不然生成东西为空</span><br><span class="line">openssl rsa -<span class="keyword">in</span> www.example.com.pem -out www.example.com.key</span><br><span class="line">// f. 生成签名请求</span><br><span class="line">openssl req -new -key www.example.com.pem -out www.example.com.csr</span><br><span class="line">// g. 用ca进行签名</span><br><span class="line">openssl ca -policy policy_anything -days 1460 -cert ca.crt -keyfile ca.key -<span class="keyword">in</span> www.example.com.csr -out www.example.com.crt</span><br></pre></td></tr></table></figure>
</li>
<li><p>遇到问题</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// problem default_ca</span><br><span class="line">Using configuration from /private/etc/ssl/openssl.cnf</span><br><span class="line">variable lookup failed <span class="keyword">for</span> ca::default_ca</span><br><span class="line">// 将openssl安装目录下的openssl.cnf 拷贝到配置目录 </span><br><span class="line">cp /usr/<span class="built_in">local</span>/etc/openssl/openssl.cnf /private/etc/ssl/openssl.cnf</span><br><span class="line">//修改路径 置文件的dir的文件路径为之前创建的demoCA文件路径</span><br><span class="line">dir &gt;&gt; = /Users/weiqian/sshkey/demoCA &gt; &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>具体操作演示</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ <span class="built_in">cd</span> ~ &amp;&amp; mkdir sshkey &amp;&amp;  <span class="built_in">cd</span> sshkey &amp;&amp; mkdir demoCA &amp;&amp; <span class="built_in">cd</span> demoCA &amp;&amp; touch index.txt &amp;&amp; touch serial &amp;&amp; <span class="built_in">echo</span> <span class="string">"01"</span>&gt;./serial &amp;&amp; mkdir newcerts</span><br><span class="line">➜  demoCA openssl genrsa -des3 -out ca.key 2048</span><br><span class="line"></span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">................................................+++</span><br><span class="line">..............+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">Enter pass phrase <span class="keyword">for</span> ca.key:</span><br><span class="line">Verifying - Enter pass phrase <span class="keyword">for</span> ca.key:</span><br><span class="line">➜  demoCA openssl req -new -x509 -days 7305 -key ca.key -out ca.crt</span><br><span class="line">Enter pass phrase <span class="keyword">for</span> ca.key:</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">'.'</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) []:cn</span><br><span class="line">State or Province Name (full name) []:shenzhen</span><br><span class="line">Locality Name (eg, city) []:shenzhen</span><br><span class="line">Organization Name (eg, company) []:xxxxx</span><br><span class="line">Organizational Unit Name (eg, section) []:dp</span><br><span class="line">Common Name (eg, fully qualified host name) []:www.example.com</span><br><span class="line">Email Address []:</span><br><span class="line">➜  demoCA openssl genrsa -des3 -out www.example.com.pem 1024</span><br><span class="line">Generating RSA private key, 1024 bit long modulus</span><br><span class="line">..........++++++</span><br><span class="line">.......................++++++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">Enter pass phrase <span class="keyword">for</span> www.example.com.pem:</span><br><span class="line">Verifying - Enter pass phrase <span class="keyword">for</span> www.example.com.pem:</span><br><span class="line">➜  demoCA openssl rsa -<span class="keyword">in</span> www.example.com.pem -out www.example.com.key</span><br><span class="line">Enter pass phrase <span class="keyword">for</span> www.example.com.pem:</span><br><span class="line">writing RSA key</span><br><span class="line">➜  demoCA openssl req -new -key www.example.com.pem -out www.example.com.csr</span><br><span class="line">Enter pass phrase <span class="keyword">for</span> www.example.com.pem:</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">'.'</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) []:cn</span><br><span class="line">State or Province Name (full name) []:shenzhen</span><br><span class="line">Locality Name (eg, city) []:shenzhen</span><br><span class="line"><span class="comment"># testoid2=$&#123;testoid1&#125;.5.6</span></span><br><span class="line">Organization Name (eg, company) []:xxxxx</span><br><span class="line">Organizational Unit Name (eg, section) []:dp</span><br><span class="line">Common Name (eg, fully qualified host name) []:www.example.com</span><br><span class="line">Email Address []:</span><br><span class="line"></span><br><span class="line">Please enter the following <span class="string">'extra'</span> attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:</span><br><span class="line">➜  demoCA openssl ca -policy policy_anything -days 1460 -cert ca.crt -keyfile ca.key -<span class="keyword">in</span> www.example.com.csr -out www.example.com.crt</span><br><span class="line">Using configuration from /private/etc/ssl/openssl.cnf</span><br><span class="line">variable lookup failed <span class="keyword">for</span> ca::default_ca</span><br><span class="line">140735671473096:error:0E06D06C:configuration file routines:NCONF_get_string:no value:/BuildRoot/Library/Caches/com.apple.xbs/Sources/libressl/libressl-22.50.2/libressl/crypto/conf/conf_lib.c:323:group=ca name=default_ca</span><br><span class="line">➜  demoCA cp /usr/<span class="built_in">local</span>/etc/openssl/openssl.cnf /private/etc/ssl/openssl.cnf</span><br><span class="line">cp: /private/etc/ssl/openssl.cnf: Permission denied</span><br><span class="line">➜  demoCA sudo cp /usr/<span class="built_in">local</span>/etc/openssl/openssl.cnf /private/etc/ssl/openssl.cnf</span><br><span class="line">Password:</span><br><span class="line">➜  demoCA <span class="built_in">pwd</span></span><br><span class="line">/Users/weiqian/sshkey/demoCA</span><br><span class="line">➜  demoCA vim /private/etc/ssl/openssl.cnf</span><br><span class="line">➜  demoCA sudo vim /private/etc/ssl/openssl.cnf</span><br><span class="line">➜  demoCA openssl ca -policy policy_anything -days 1460 -cert ca.crt -keyfile ca.key -<span class="keyword">in</span> www.example.com.csr -out www.example.com.crt</span><br><span class="line">Using configuration from /private/etc/ssl/openssl.cnf</span><br><span class="line">Enter pass phrase <span class="keyword">for</span> ca.key:</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">Certificate Details:</span><br><span class="line">        Serial Number: 1 (0x1)</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Oct 10 15:32:09 2018 GMT</span><br><span class="line">            Not After : Oct  9 15:32:09 2022 GMT</span><br><span class="line">        Subject:</span><br><span class="line">            countryName               = cn</span><br><span class="line">            stateOrProvinceName       = shenzhen</span><br><span class="line">            localityName              = shenzhen</span><br><span class="line">            organizationName          = xxxxx</span><br><span class="line">            organizationalUnitName    = dp</span><br><span class="line">            commonName                = www.example.com</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Basic Constraints:</span><br><span class="line">                CA:FALSE</span><br><span class="line">            Netscape Comment:</span><br><span class="line">                OpenSSL Generated Certificate</span><br><span class="line">            X509v3 Subject Key Identifier:</span><br><span class="line">                F1:2E:2B:F6:C9:8E:3F:34:B9:A7:B8:96:45:92:21:47:35:54:F2:84</span><br><span class="line">            X509v3 Authority Key Identifier:</span><br><span class="line">                DirName:/C=cn/ST=shenzhen/L=shenzhen/O=xxxxx/OU=dp/CN=www.example.com</span><br><span class="line">                serial:F8:D7:C0:D0:73:1E:B4:91</span><br><span class="line"></span><br><span class="line">Certificate is to be certified until Oct  9 15:32:09 2022 GMT (1460 days)</span><br><span class="line">Sign the certificate? [y/n]:y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1 out of 1 certificate requests certified, commit? [y/n]y</span><br><span class="line">Write out database with 1 new entries</span><br><span class="line">Data Base Updated</span><br><span class="line">➜  demoCA ls</span><br><span class="line">ca.crt              index.txt.attr      serial              www.example.com.csr</span><br><span class="line">ca.key              index.txt.old       serial.old          www.example.com.pem</span><br><span class="line">index.txt           newcerts            www.example.com.crt</span><br><span class="line">➜  demoCA sudo vim /etc/hosts</span><br><span class="line">Password:</span><br><span class="line">➜  demoCA <span class="built_in">cd</span> ..</span><br><span class="line">➜  sshkey touch nginx-https.conf</span><br><span class="line">➜  sshkey vim nginx-https.conf</span><br><span class="line">➜  sshkey vim index.html</span><br><span class="line">➜  sshkey sudo nginx -s stop</span><br><span class="line">➜  sshkey sudo  nginx -c  /Users/weiqian/sshkey/nginx-https.conf</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="三、nginx配置"><a href="#三、nginx配置" class="headerlink" title="三、nginx配置"></a>三、nginx配置</h3><ol>
<li><p>修改host</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/hosts</span><br><span class="line">127.0.0.1 www.example.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>nginx-https.conf</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span> root owner;</span><br><span class="line"><span class="attribute">worker_processes</span> <span class="number">1</span>;</span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line"> <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line">http&#123;</span><br><span class="line">  server&#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> www.example.com;</span><br><span class="line">    <span class="attribute">root</span> /Users/weiqian/sshkey;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">      <span class="attribute">return</span>   <span class="number">301</span>  https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="section">server</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">server_name</span> www.example.com;</span><br><span class="line">    <span class="attribute">root</span> /Users/weiqian/sshkey;</span><br><span class="line">    <span class="attribute">ssl_certificate</span>       /Users/weiqian/sshkey/demoCA/www.example.com.crt; </span><br><span class="line">    <span class="attribute">ssl_certificate_key</span>   /Users/weiqian/sshkey/demoCA/www.example.com.key; </span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">      <span class="attribute">index</span> index.html;</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="attribute">location</span> /produk-digital/m &#123;</span><br><span class="line">        <span class="attribute">try_files</span>     <span class="variable">$uri</span>      /digital-product/m/index.html;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> = /digital-product/m/index.html &#123;</span><br><span class="line">        <span class="attribute">alias</span>       /Users/weiqian/sshkey/index.html;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行nginx</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -s stop</span><br><span class="line">sudo  nginx -c  /Users/weiqian/sshkey/nginx-https.conf</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>访问 <a href="http://www.example.com" target="_blank" rel="noopener">www.example.com</a></p>
<h3 id="四、chrome将证书设置为始终信任"><a href="#四、chrome将证书设置为始终信任" class="headerlink" title="四、chrome将证书设置为始终信任"></a>四、chrome将证书设置为始终信任</h3><ol>
<li>打开浏览器，访问 <a href="http://www.example.com，点击=&gt;tab不安全=&gt;证书=&gt;图标拖到桌面" target="_blank" rel="noopener">www.example.com，点击=&gt;tab不安全=&gt;证书=&gt;图标拖到桌面</a></li>
<li>打开钥匙串，把桌面的证书拖进去[系统|证书]，选择始终信任</li>
<li>重新访问<a href="http://www.example.com，页面内容显示test" target="_blank" rel="noopener">www.example.com，页面内容显示test</a> https example</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/09/linux常用基础操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="weiqian">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="There is no magic">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/09/linux常用基础操作/" class="post-title-link" itemprop="url">linux常用基础操作</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-10-09 20:57:58" itemprop="dateCreated datePublished" datetime="2018-10-09T20:57:58+00:00">2018-10-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-09 20:26:28" itemprop="dateModified" datetime="2021-05-09T20:26:28+00:00">2021-05-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tools/" itemprop="url" rel="index"><span itemprop="name">tools</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>liunx有很多优秀的地方，用了mac后确实再也不想用windows了，简单记录下工作日常需要了解的一些基础知识。</p>
<h3 id="一、文件权限和目录"><a href="#一、文件权限和目录" class="headerlink" title="一、文件权限和目录"></a>一、文件权限和目录</h3><ol>
<li><p>多用户、多任务环境，文件可存取访问的身份owner|group|other，3种身份各有read4r|write2w|execute1x</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  man ls  // 详细的命令</span><br><span class="line">➜  info ls </span><br><span class="line">➜  ll // 文件权限|连接数|文件所属者|文件所属用户组|文件大小|文件最后修改时间|文件名</span><br><span class="line">➜  whoami</span><br><span class="line">➜  id -a weiqian</span><br><span class="line">➜  groups</span><br><span class="line">➜  id -a root</span><br><span class="line">➜  sudo chown root:wheel demo</span><br><span class="line">➜  sudo chomd 777 demo</span><br></pre></td></tr></table></figure>
</li>
<li><p>linux目录配置标准FHS</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/ 根目录，与开机系统有关</span><br><span class="line">/usr（UNIX software resource） 与软件安装执行有关</span><br><span class="line">/var (variable) 与系统运作过程有关</span><br><span class="line">/bin 重要的执行文件，主要有cat|chomod|chown|date|mv|mkdir|cp|bash</span><br><span class="line">/sbin 重要的系统执行文件</span><br><span class="line">/etc 系统配置文件，例如人员的账号密码配置，各种文件的起始文件</span><br><span class="line">/home 用户的住文件夹</span><br><span class="line">/opt 第三方软件的放置目录（非原本的distribution）</span><br></pre></td></tr></table></figure>
</li>
<li><p>目录相关操作</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.  此层目录</span><br><span class="line">.. 上层目录</span><br><span class="line">-  前一个工作目录</span><br><span class="line">~  目前用户身份所在的主文件夹</span><br><span class="line"><span class="built_in">pwd</span>|mkdir|rmdir //处理目录</span><br><span class="line">cp|rm|mv        //复制删除移动</span><br><span class="line">cat|tac|nl|more|less|head|tail //查看文件</span><br><span class="line">touch //修改文件时间或者创建新文件</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="二、硬件、内核与shell"><a href="#二、硬件、内核与shell" class="headerlink" title="二、硬件、内核与shell"></a>二、硬件、内核与shell</h3><ol>
<li><p>什么是shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">我们必须通过shell讲我们输入的命令与内核通信，好让内核可以控制硬件来正确无误的工作。操作系统其实是一组软件，由于这组软件在控制整个硬件与管理系统的活动检测，如果这组软件能被用户随意操作，若用户使用不当，将会使得系统崩溃。因为操作系统就是管理整个硬件功能，所以不能随便被一些没有管理能里的终端用户随意使用。</span><br><span class="line">shell的功能只是提供用户操作系统的一个接口，因此这个shell需要调用其他软件才好，例如man|chmod|vi等等，这些命令都是独立的应用程序，但是我们可以通过shell(就是命令行模式)来操作这些应用程序，让这些应用程序调用内核来运行所需的工作。</span><br></pre></td></tr></table></figure>
</li>
<li><p>我们常用的shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">（Bourne Again Shell）简称bash，这个shell是Bourne Shell的增强版本</span><br><span class="line">/bin/sh(已经被/bin/bash替代)</span><br><span class="line">/bin/bash(linux的默认的)</span><br><span class="line">/bin/ksh</span><br><span class="line">/bin/tcsh</span><br><span class="line">/bin/csh</span><br><span class="line">/bin/zsh(基于ksh发展出来的，功能更强大的的shell)</span><br></pre></td></tr></table></figure>
</li>
<li><p>bash shell的功能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">命令记忆功能 history</span><br><span class="line">命令与文件补全功能 tab</span><br><span class="line">命令别名设置功能 alias</span><br></pre></td></tr></table></figure>
</li>
<li><p>shell的变量功能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">影响你能不能在任何目录下执行某个命令与PATH这个变量有很大关系，例如你在执行ls这个命令时候系统就是通过PATH这个变量里面的内容所记录的路径顺序来查找命令的，如果PATH这个变量里面路径还找不到ls这个命令时候，就会在屏幕上显示 “command not found”</span><br><span class="line">在linux下所有的执行都需要一个执行码，你真正以shell来跟linux通信，是在正确登陆linux之后，这个时候你就有一个bash的可执行程序，也才可以真正经由bash和系统通信。而在进入shell之前，由于系统需要一些变量来提供它的数据访问，所以就有了一些环境变量需要读入系统。例如PATH|HOME|MAIL|SHELL，为了区分和自定义变量不通，环境变量通常用大些表示。</span><br></pre></td></tr></table></figure>
</li>
<li><p>变量的显示和设置</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 变量显示echo，只要在变量名称前面加上$</span><br><span class="line">➜  / echo $PATH</span><br><span class="line">/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/go/bin</span><br><span class="line">// 若为了该变量增加变量内容时候，可用‘$变量’累加内容，例如 PATH=“$PATH&quot;:/home/bin</span><br></pre></td></tr></table></figure>
<h3 id="三、bash的环境配置文件"><a href="#三、bash的环境配置文件" class="headerlink" title="三、bash的环境配置文件"></a>三、bash的环境配置文件</h3><ol>
<li><p>我们知道查看文件属性的命令ls的完整文件名为:/bin/ls，问题来了，为什么我可以在任何地方执行/bin/ls这个命令呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">当我们在执行一个命令时候，系统会按照PATH的设置去每个PATH定义的目录下查询文件名为ls的可执行文件，如果在PATH定义的目录中含有多个文件名字为ls的可执行文件，那么先查询到的同名命令会被执行</span><br></pre></td></tr></table></figure>
</li>
<li><p>我们什么都没做，但是已进入bash就取得一堆有用的变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这是因为操作系统有一些环境配置文件的存在，让bash在启动的时候就直接读取了这些配置文件，以规划好bash的操作环境，这些环境又分为系统文件和个人偏好配置文件。</span><br></pre></td></tr></table></figure>
</li>
<li><p>~/.bash_profile (login shell才会读取)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash在读完了整体环境变量设置的/etc/profile并借此调用其他的配置文件之后，接下来会读取用户的个人配置文件，在login shell的配置文件种，所读取的个人偏好文件有3个依次是 ~/.bash_profile | ~/.bash_login | ~/.profile，按照顺序读取其中的一个</span><br></pre></td></tr></table></figure>
</li>
<li><p>source 读取环境配置文件的命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">由于/etc/profile与~/.bash_profile都是在取得login shell的时候才会读取的配置文件，所以如果你将自己的偏好设置写入上述文件后，通常都是注销在登陆后设置才能生效，想要不注销直接读取文件，就要利用source这个文件。</span><br></pre></td></tr></table></figure>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/26/react-i18next的应用及工作原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="weiqian">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="There is no magic">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/26/react-i18next的应用及工作原理/" class="post-title-link" itemprop="url">react-i18next的应用及工作原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-26 10:37:57" itemprop="dateCreated datePublished" datetime="2018-09-26T10:37:57+00:00">2018-09-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-09 20:26:28" itemprop="dateModified" datetime="2021-05-09T20:26:28+00:00">2021-05-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/react/" itemprop="url" rel="index"><span itemprop="name">react</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="一、相关资料"><a href="#一、相关资料" class="headerlink" title="一、相关资料"></a>一、相关资料</h3><p>我理解的i18n的原理就是字符串替换。根据语言拉取不同的json文件，再根据key做一个映射取到预期的结果。<br><a href="https://www.i18next.com/" target="_blank" rel="noopener">i18next官方文档</a><br><a href="https://react.i18next.com/" target="_blank" rel="noopener">react-i18next官方文档</a></p>
<h3 id="二、i18next的基本API"><a href="#二、i18next的基本API" class="headerlink" title="二、i18next的基本API"></a>二、i18next的基本API</h3><ol>
<li><p>init 默认的的i18next模块是一个已经被init初始化后的i18next实例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// i18next.init(option,callback) </span></span><br><span class="line"><span class="comment">// 具体的[option](https://www.i18next.com/overview/configuration-options)</span></span><br><span class="line"><span class="comment">// i18next instance</span></span><br><span class="line"><span class="keyword">const</span> resources = process.env.LANGUAGE.resources</span><br><span class="line"><span class="keyword">const</span> language = <span class="built_in">Object</span>.keys(resources)[<span class="number">0</span>]</span><br><span class="line">i18next</span><br><span class="line">  .init(&#123;</span><br><span class="line">    lng: language, <span class="comment">// language to use</span></span><br><span class="line">    fallbackLng: language, <span class="comment">// language to use if translations in user language are not available</span></span><br><span class="line">    defaultNS: <span class="string">'common'</span>,<span class="comment">// default namespace used if not passed to translation function​</span></span><br><span class="line">    keySeparator: <span class="literal">false</span>, <span class="comment">//char to separate keys</span></span><br><span class="line">    debug: process.env.NODE_ENV === <span class="string">'development'</span>,</span><br><span class="line">    resources, <span class="comment">// resources to initialize with (if not using loading or not appending using addResourceBundle)</span></span><br><span class="line">    interpolation: &#123;</span><br><span class="line">      escapeValue: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    react: &#123;</span><br><span class="line">      wait: <span class="literal">true</span>,</span><br><span class="line">      bindI18n: <span class="string">'languageChanged loaded'</span>,<span class="comment">// which events trigger a rerender, can be set to false or string of events</span></span><br><span class="line">      bindStore: <span class="string">'added removed'</span>,<span class="comment">// which events on store trigger a rerender, can be set to false or string of events</span></span><br><span class="line">      nsMode: <span class="string">'default'</span> <span class="comment">// default: namespaces will be loaded an the first will be set as default or fallback: namespaces will be used as fallbacks used in order provided</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>t</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//i18next.t(keys,options)</span></span><br><span class="line"><span class="comment">//i18next.t('my.key') // will return value in set language</span></span><br><span class="line"><span class="keyword">const</span> firstLetterUpper = <span class="function">(<span class="params">str, allWords = <span class="literal">true</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> tmp = str.replace(<span class="regexp">/^(.)/g</span>, $<span class="number">1</span> =&gt; $<span class="number">1.</span>toUpperCase())</span><br><span class="line">  <span class="keyword">if</span> (allWords) &#123;</span><br><span class="line">    tmp = tmp.replace(<span class="regexp">/\s(.)/g</span>, $<span class="number">1</span> =&gt; $<span class="number">1.</span>toUpperCase())</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> tmp</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> tUpper = <span class="function">(<span class="params">str, allWords = <span class="literal">true</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> firstLetterUpper(i18next.t(str), allWords)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>changeLanguage 切换语言</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//i18next.changeLanguage(lng, callback)</span></span><br><span class="line">i18next.changeLanguage(<span class="string">'en'</span>, (err, t) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.log(<span class="string">'something went wrong loading'</span>, err);</span><br><span class="line">  t(<span class="string">'key'</span>); <span class="comment">// -&gt; same as i18next.t</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> changeLanguage = <span class="function">(<span class="params">locale</span>) =&gt;</span> &#123;</span><br><span class="line">  i18next.changeLanguage(locale)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="三、react部分"><a href="#三、react部分" class="headerlink" title="三、react部分"></a>三、react部分</h3><ol>
<li><p>引入react-i18next,用I18nextProvider将i18注入到componet(例子里面是App)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;I18nextProvider i18n=&#123;i18n&#125;&gt;</span><br><span class="line">    &lt;App /&gt;</span><br><span class="line">  &lt;/I18nextProvider&gt;,</span><br><span class="line">  document.querySelector(&apos;#root&apos;)</span><br><span class="line">)r</span><br></pre></td></tr></table></figure>
</li>
<li><p>在遇到需要国际化的地方调用translation即可{tUpper(‘xxx_key’)}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class App extends React.Component &#123;</span><br><span class="line">  render () &#123;</span><br><span class="line">    return &lt;h1&gt;&#123;tUpper(&apos;order_id&apos;)&#125;&lt;/h1&gt;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="四、本地翻译文件部分"><a href="#四、本地翻译文件部分" class="headerlink" title="四、本地翻译文件部分"></a>四、本地翻译文件部分</h3><p>上面部分展示了i18n是怎么工作的，在实际的项目中，我们会有很多的需要翻译的文件，如何工程化的组织和加载这些文件呢，我们的目录结构如下<br>i18n<br>├── index.js //自动拉取线上的翻译文件，避免手动导入。 script里面可以放脚本 node i18n/index.js 先执行这个，在执行正常工作目录<br>├── locales //翻译文件具体内容<br>│   ├── en.json<br>│   ├── id-ID.json<br>│   ├── ms-MY.json<br>│   ├── th-TH.json<br>│   ├── vi-VN.json<br>│   ├── zh-Hans.json<br>│   └── zh-Hant.json<br>├── localesHash.js //国家对应的语言hash<br>└── resourcesHash.js //语言对应的资源文件包</p>
<h3 id="五、webpack加载配置"><a href="#五、webpack加载配置" class="headerlink" title="五、webpack加载配置"></a>五、webpack加载配置</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//国家对应的语言hash</span></span><br><span class="line"><span class="keyword">const</span> localesHash = <span class="built_in">require</span>(<span class="string">'./i18n/localesHash'</span>)</span><br><span class="line"><span class="comment">//语言对应资源hash</span></span><br><span class="line"><span class="keyword">const</span> resourcesHash = <span class="built_in">require</span>(<span class="string">'./i18n/resourcesHash'</span>)</span><br><span class="line"><span class="comment">//webpack.config.js</span></span><br><span class="line"><span class="keyword">const</span> config = <span class="function">(<span class="params">env = &#123;&#125;, argv</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> isProductionMode = argv.mode === <span class="string">'production'</span></span><br><span class="line">  <span class="keyword">const</span> country = (env.country || <span class="string">'en'</span>).toUpperCase()</span><br><span class="line">  <span class="keyword">const</span> locales = (localesHash[country] || []).concat([<span class="string">'en'</span>])</span><br><span class="line">  <span class="keyword">const</span> resources = locales.reduce(</span><br><span class="line">    (previous, current) =&gt; &#123;</span><br><span class="line">      previous[current] = &#123;</span><br><span class="line">        common: resourcesHash[current]</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> previous</span><br><span class="line">    &#125;, &#123;&#125;)</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    plugins: [</span><br><span class="line">      <span class="keyword">new</span> webpack.EnvironmentPlugin(&#123;</span><br><span class="line">        NODE_ENV: isProductionMode ? <span class="string">'production'</span> : <span class="string">'development'</span>,</span><br><span class="line">        SERVER_ENV: env.server || <span class="string">'test'</span>,</span><br><span class="line">        COUNTRY: country,</span><br><span class="line">        LANGUAGE: &#123;</span><br><span class="line">          resources</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="六、相应的package-json配置"><a href="#六、相应的package-json配置" class="headerlink" title="六、相应的package.json配置"></a>六、相应的package.json配置</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"debug:id"</span>: <span class="string">"webpack-dev-server  --progress  --env.country=id   --config  ./webpack.config.js"</span>,</span><br><span class="line">    <span class="attr">"debug:th"</span>: <span class="string">"webpack-dev-server  --progress   --env.country=th  --config  ./webpack.config.js"</span>,</span><br><span class="line">    <span class="attr">"start"</span>: <span class="string">"webpack-dev-server --mode  development  --config  ./webpack.config.js"</span>,</span><br><span class="line">    <span class="attr">"i18n"</span>: <span class="string">"node i18n/index.js"</span>,</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"webpack --config  ./webpack.config.js"</span>,</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="七、问题记录"><a href="#七、问题记录" class="headerlink" title="七、问题记录"></a>七、问题记录</h3><ol>
<li>每次正常启动访问<a href="http://localhost:9000之后总是自动跳到http://localhost:9000/auth/login，看了代码里面并没有任何关于权限的跳转逻辑，怀疑是本机ngnix或者别的程序影响的" target="_blank" rel="noopener">http://localhost:9000之后总是自动跳到http://localhost:9000/auth/login，看了代码里面并没有任何关于权限的跳转逻辑，怀疑是本机ngnix或者别的程序影响的</a><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  init-i18n git:(master) ✗ lsof -i :9000</span><br><span class="line">COMMAND   PID    USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME</span><br><span class="line">com.docke 655 weiqian   18u  IPv4 0x673df5045a8519a5      0t0  TCP *:cslistener (LISTEN)</span><br><span class="line">com.docke 655 weiqian   19u  IPv6 0x673df5045531595d      0t0  TCP localhost:cslistener (LISTEN)</span><br><span class="line">➜  init-i18n git:(master) ✗ <span class="built_in">kill</span> -9 655</span><br><span class="line">➜  init-i18n git:(master) ✗ lsof -i :9000</span><br><span class="line">➜  init-i18n git:(master) ✗ npm run start</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>果然，docker的进程影响到，在重启世界和平。</p>
<ol start="2">
<li><p>刚开始怎么写代码都只能翻译英语的，智商捉鸡，orz</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//有bug的代码</span></span><br><span class="line"><span class="comment">//webpack.config.js里面</span></span><br><span class="line"><span class="keyword">const</span> country = (env.country || <span class="string">'en'</span>).toUpperCase()</span><br><span class="line"><span class="keyword">const</span> locales = [<span class="string">'en'</span>].concat(localesHash[country]) <span class="comment">// wrong</span></span><br><span class="line"><span class="comment">// const locales = (localesHash[country] || []).concat(['en']) // right</span></span><br><span class="line"><span class="keyword">const</span> resources = locales.reduce(</span><br><span class="line">    (previous, current) =&gt; &#123;</span><br><span class="line">        previous[current] = &#123;</span><br><span class="line">        common: resourcesHash[current]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> previous</span><br><span class="line">    &#125;, &#123;&#125;)</span><br><span class="line"><span class="comment">//i18n里面选择的</span></span><br><span class="line"><span class="keyword">const</span> resources = process.env.LANGUAGE.resources</span><br><span class="line"><span class="comment">//这里选择默认选择的是第一个，所以webpack里面的resource顺序就很重要</span></span><br><span class="line"><span class="keyword">const</span> language = <span class="built_in">Object</span>.keys(resources)[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p>错误地方好弱智</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> locales = [<span class="string">'en'</span>].concat(localesHash[country])</span><br><span class="line"><span class="comment">// locales的第一个永远是en那么选择策略 Object.keys(resources)[0] 永远都选第一个</span></span><br><span class="line"><span class="comment">//改正到正确代码</span></span><br><span class="line"><span class="keyword">const</span> locales = (localesHash[country] || []).concat([<span class="string">'en'</span>])</span><br></pre></td></tr></table></figure>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/21/webpack解决跨越问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="weiqian">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="There is no magic">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/21/webpack解决跨越问题/" class="post-title-link" itemprop="url">webpack解决跨越问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-21 18:34:25" itemprop="dateCreated datePublished" datetime="2018-09-21T18:34:25+00:00">2018-09-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-09 20:26:28" itemprop="dateModified" datetime="2021-05-09T20:26:28+00:00">2021-05-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/react/" itemprop="url" rel="index"><span itemprop="name">react</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="一、场景"><a href="#一、场景" class="headerlink" title="一、场景"></a>一、场景</h3><p>  本机起一个web的服务，访问后台接口<br>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.fetch(<span class="string">'https://dp-admin.test.xxxxx.io/api/order/list?page=1&amp;page_size=10'</span>, &#123;<span class="attr">method</span>: <span class="string">'get'</span>&#125;).then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> response.json()</span><br><span class="line">&#125;).then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(data)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>  跨域报错如下，可以说很日常了<br>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost/:1 Failed to load https://dp-admin.test.xxxxx.io/api/order/list?page=1&amp;page_size=10: No <span class="string">'Access-Control-Allow-Origin'</span> header is present on the requested resource. Origin <span class="string">'http://localhost:8080'</span> is therefore not allowed access. If an opaque response serves your needs, <span class="built_in">set</span> the request<span class="string">'s mode to '</span>no-cors<span class="string">' to fetch the resource with CORS disabled.</span></span><br></pre></td></tr></table></figure></p>
<h3 id="二、本地搭建一个服务器做转发"><a href="#二、本地搭建一个服务器做转发" class="headerlink" title="二、本地搭建一个服务器做转发"></a>二、本地搭建一个服务器做转发</h3>   <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">'request'</span>)</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> testHost = <span class="string">'http://dp-admin.test.xxxxx.io'</span></span><br><span class="line"><span class="keyword">const</span> dpHost = process.env.HOST || testHost</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">'/api'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line"> <span class="built_in">console</span>.log(<span class="string">'req----&gt;'</span>, dpHost + req.originalUrl)</span><br><span class="line"> <span class="keyword">const</span> requestObj = request[req.method.toLowerCase()](&#123;</span><br><span class="line">   url: dpHost + req.originalUrl</span><br><span class="line"> &#125;)</span><br><span class="line"> req.pipe(requestObj)</span><br><span class="line"> requestObj.pipe(res)</span><br><span class="line">&#125;)</span><br><span class="line">app.listen(<span class="number">3001</span>)</span><br></pre></td></tr></table></figure>
<p>   浏览器访问<a href="http://localhost:3001/api/order/list?page=1&amp;page_size=10返回如下" target="_blank" rel="noopener">http://localhost:3001/api/order/list?page=1&amp;page_size=10返回如下</a><br>   <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"err_code"</span>: <span class="number">32</span>,</span><br><span class="line">  <span class="string">"err_msg"</span>: <span class="string">"not login"</span>,</span><br><span class="line">  <span class="string">"data"</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>   证明我们写的代理服务请求没问题</p>
<h3 id="三、-设置webpack的devServer"><a href="#三、-设置webpack的devServer" class="headerlink" title="三、 设置webpack的devServer"></a>三、 设置webpack的devServer</h3>   <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">proxy: &#123;</span><br><span class="line">  '/api': 'http://localhost:3001'</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>   重新请求报错和刚才一样，为什么呢？ 页面的访问地址是<a href="http://localhost:8080/" target="_blank" rel="noopener">http://localhost:8080/</a> 我们请求的地址是<a href="https://dp-admin.test.xxxxx.io/api/order/list?page=1&amp;page_size=10，这里http://localhost:8080/" target="_blank" rel="noopener">https://dp-admin.test.xxxxx.io/api/order/list?page=1&amp;page_size=10，这里http://localhost:8080/</a> 和<a href="https://dp-admin.test.xxxxx.io明显不是一个域名，也就是说请求和devServer服务器是跨域的，则不存在devServer正常响应重新转发到&#39;http://localhost:3001&#39;，本地express服务是没有工作的。所以我们改下代码入下" target="_blank" rel="noopener">https://dp-admin.test.xxxxx.io明显不是一个域名，也就是说请求和devServer服务器是跨域的，则不存在devServer正常响应重新转发到&#39;http://localhost:3001&#39;，本地express服务是没有工作的。所以我们改下代码入下</a><br>   <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://localhost:8080//api/order/list?page=1&amp;page_size=10等效，保证和devServer同域名就好</span></span><br><span class="line"><span class="built_in">window</span>.fetch(<span class="string">'/api/order/list?page=1&amp;page_size=10'</span>, &#123;<span class="attr">method</span>: <span class="string">'get'</span>&#125;).then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> response.json()</span><br><span class="line">&#125;).then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(data)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>   果然跨域问题解决了，express也看到了日志进去了<br>   <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"err_code"</span>:<span class="number">32</span>,<span class="string">"err_msg"</span>:<span class="string">"not login"</span>,<span class="string">"data"</span>:<span class="literal">null</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>   返回没有登陆，我们实际的页面已经登陆了<a href="https://dp-admin.test.xxxxx.io/" target="_blank" rel="noopener">https://dp-admin.test.xxxxx.io/</a> ，我们本地的页面地址是<a href="http://localhost:8080/" target="_blank" rel="noopener">http://localhost:8080/</a> 这种情况下cookie明显写不进去，所以做如下设置</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">devServer: &#123;</span><br><span class="line">   port: &apos;8080&apos;,</span><br><span class="line">   host: &apos;dp-admin.test.xxxxx.io&apos;,</span><br><span class="line">   contentBase: path.join(__dirname, &apos;../public&apos;),</span><br><span class="line">   compress: true,</span><br><span class="line">   historyApiFallback: true,</span><br><span class="line">   hot: true,</span><br><span class="line">   https: false,</span><br><span class="line">   noInfo: true,</span><br><span class="line">   open: true,</span><br><span class="line">   proxy: &#123;</span><br><span class="line">      &apos;/api&apos;: &apos;http://localhost:3001&apos;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>   运行 npm run dev，报错如下<br>   <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; webpack-dev-server --inline --progress --config build/webpack.dev.conf.js</span><br><span class="line"></span><br><span class="line"> 10% building modules 1/1 modules 0 activeevents.js:167</span><br><span class="line">     throw er; // Unhandled <span class="string">'error'</span> event</span><br><span class="line">     ^</span><br><span class="line"></span><br><span class="line"> Error: listen EADDRNOTAVAIL 203.117.178.74:8080</span><br><span class="line">     at Server.setupListenHandle [as _listen2] (net.js:1313:19)</span><br><span class="line">     at listenInCluster (net.js:1378:12)</span><br><span class="line">     at GetAddrInfoReqWrap.doListen [as callback] (net.js:1491:7)</span><br><span class="line">     at GetAddrInfoReqWrap.onlookup [as oncomplete] (dns.js:55:10)</span><br><span class="line"> Emitted <span class="string">'error'</span> event at:</span><br><span class="line">     at emitErrorNT (net.js:1357:8)</span><br><span class="line">     at process._tickCallback (internal/process/next_tick.js:174:19)</span><br></pre></td></tr></table></figure></p>
<p>   增加本地代理<br>   <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/hosts</span><br><span class="line">127.0.0.1 dp-admin.test.xxxxx.io</span><br></pre></td></tr></table></figure></p>
<p>   npm run dev<br>   <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">➜  webpack-cross git:(master) ✗ npm run dev</span><br><span class="line"></span><br><span class="line"> &gt; webpack-cross@1.0.0 dev /Users/weiqian/Desktop/xxxxx/webpack-cross</span><br><span class="line"> &gt; webpack-dev-server --inline --progress --config build/webpack.dev.conf.js</span><br><span class="line"></span><br><span class="line"> [HPM] Error occurred <span class="keyword">while</span> trying to proxy request /api/order/list?page=1&amp;page_size=10 from dp-admin.test.xxxxx.io:8080 to http://localhost:3001 (ECONNRESET) (https://nodejs.org/api/errors.html<span class="comment">#errors_common_system_errors)</span></span><br><span class="line"> // ECONNRESET (连接被重置): 一个连接被强行关闭。 这通常是因为连接到远程 socket 超时或重启。 常发生于 http 和 net 模块。</span><br><span class="line"> // 浏览器显示错误</span><br><span class="line">index.js:9 GET http://dp-admin.test.xxxxx.io:8080/api/order/list?page=1&amp;page_size=10 504 (Gateway Timeout)</span><br><span class="line">// prxoy服务错误</span><br><span class="line"> node data/proxy.js</span><br><span class="line"></span><br><span class="line"> req----&gt; http://dp-admin.test.xxxxx.io/api/order/list?page=1&amp;page_size=10</span><br><span class="line"> internal/streams/legacy.js:57</span><br><span class="line">     throw er; // Unhandled stream error <span class="keyword">in</span> pipe.</span><br><span class="line">     ^</span><br><span class="line"></span><br><span class="line"> Error: connect ECONNREFUSED 127.0.0.1:80</span><br><span class="line">     at TCPConnectWrap.afterConnect [as oncomplete] (net.js:1161:14)</span><br><span class="line"> npm ERR! code ELIFECYCLE</span><br><span class="line"> npm ERR! errno 1</span><br><span class="line"> npm ERR! webpack-cross@1.0.0 proxy: `node data/proxy.js`</span><br><span class="line"> npm ERR! Exit status 1</span><br><span class="line"> npm ERR!</span><br><span class="line"> npm ERR! Failed at the webpack-cross@1.0.0 proxy script.</span><br><span class="line"> npm ERR! This is probably not a problem with npm. There is likely additional logging output above.</span><br><span class="line"></span><br><span class="line"> npm ERR! A complete <span class="built_in">log</span> of this run can be found <span class="keyword">in</span>:</span><br><span class="line"> npm ERR!     /Users/weiqian/.npm/_logs/2018-09-21T12_35_13_611Z-debug.log</span><br><span class="line"></span><br><span class="line"> // 我们访问线上页面 https://dp-admin.test.xxxxx.io/ 错误</span><br><span class="line">This site can’t be reached</span><br><span class="line"> dp-admin.test.xxxxx.io refused to connect.</span><br><span class="line"> Try:</span><br><span class="line"></span><br><span class="line"> Checking the connection</span><br><span class="line"> Checking the proxy and the firewall</span><br><span class="line"> ERR_CONNECTION_REFUSED</span><br></pre></td></tr></table></figure></p>
<p>   我们设置了真实线上的域名，运行本地页面，请求被devServer转发到3001的express服务器，接着express访问了被解析到本地的机器上ECONNREFUSED，所以明显需要改配置页面不能为线上真实地址<br>   <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack</span></span><br><span class="line">devServer&#123;</span><br><span class="line">   host: <span class="string">'local.dp-admin.test.xxxxx.io'</span></span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">// /etc/hosts</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> local.dp-admin.test.xxxxx.io</span><br></pre></td></tr></table></figure></p>
<p>重新运行npm run proxy、 npm run dev错误是一样的，正常线上页面也无法访问。哦我们忘了删掉host里面的配置，express出错，删掉host配置的   127.0.0.1 dp-admin.test.xxxxx.io，世界和平啊！！！<br> <a href="https://github.com/weiqian93/react-demo/tree/master/webpack-cors" target="_blank" rel="noopener">demo地址</a></p>
<h3 id="四、create-my-app设置"><a href="#四、create-my-app设置" class="headerlink" title="四、create-my-app设置"></a>四、create-my-app设置</h3><p>  思路和webpack差不多 </p>
<ol>
<li>起本地服务(服务端请求不存在跨域问题) </li>
<li><p>package.json设置proxy(跨域)和host(cookie)</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "proxy": "node data/proxy.js",</span><br><span class="line">  "start": "HOST=local.dp-admin.test.xxxxx.io react-scripts start",</span><br><span class="line">&#125;,</span><br><span class="line">"proxy": &#123;</span><br><span class="line">  "/api": &#123;</span><br><span class="line">    "target": "http://localhost:3001/"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">componentDidMount () &#123;</span><br><span class="line">  <span class="built_in">window</span>.fetch(<span class="string">'/api/order/list?page=1&amp;page_size=10'</span>, &#123;<span class="attr">method</span>: <span class="string">'get'</span>&#125;).then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> response.json()</span><br><span class="line">    &#125;).then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(data)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/weiqian93/react-demo/tree/master/my-app-cors" target="_blank" rel="noopener">demo地址</a></p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">weiqian</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">57</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">weiqian</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

</body>
</html>
